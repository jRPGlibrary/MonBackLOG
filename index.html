<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget de commentaires pour Notion</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 10px;
            background-color: transparent;
        }
        .comment-system {
            max-width: 100%;
        }
        .comment-input {
            width: 100%;
            height: 80px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
        }
        .comment-submit {
            padding: 8px 16px;
            background-color: #2eaadc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .comment {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 14px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div id="comment-system" class="comment-system">
        <!-- Le système de commentaires sera injecté ici -->
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAFsnabnd0A0LeEwO3w9gK-6fhc_rWSnNU",
            authDomain: "jrpglibrary-38e6c.firebaseapp.com",
            projectId: "jrpglibrary-38e6c",
            storageBucket: "jrpglibrary-38e6c.appspot.com",
            messagingSenderId: "82820484706",
            appId: "1:82820484706:web:b1130a49ee3f47c0198b3b",
            measurementId: "G-98KKZX26D8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        class CommentSystem {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.pageId = new URLSearchParams(window.location.search).get('pageId');
                if (!this.pageId) {
                    this.container.innerHTML = 'Erreur: pageId manquant';
                    return;
                }
                this.render();
                this.loadComments();
            }

            render() {
                this.container.innerHTML = `
                    <textarea class="comment-input" placeholder="Écrivez votre commentaire ici..."></textarea>
                    <button class="comment-submit">Envoyer</button>
                    <div class="comments-container"></div>
                `;
                this.container.querySelector('.comment-submit').addEventListener('click', () => this.submitComment());
            }

            async submitComment() {
                const commentText = this.container.querySelector('.comment-input').value.trim();
                if (commentText) {
                    try {
                        const docRef = await addDoc(collection(db, 'comments'), {
                            text: commentText,
                            pageId: this.pageId,
                            timestamp: serverTimestamp()
                        });
                        console.log("Document written with ID: ", docRef.id);
                        this.container.querySelector('.comment-input').value = '';
                        
                        // Ajouter le nouveau commentaire à l'affichage immédiatement
                        this.addCommentToDisplay(commentText);
                    } catch (error) {
                        console.error('Erreur lors de l\'ajout du commentaire:', error);
                    }
                }
            }

            addCommentToDisplay(text) {
                const commentsContainer = this.container.querySelector('.comments-container');
                const commentElement = document.createElement('div');
                commentElement.classList.add('comment');
                commentElement.textContent = text;
                commentsContainer.insertBefore(commentElement, commentsContainer.firstChild);
            }

            async loadComments() {
                const commentsContainer = this.container.querySelector('.comments-container');
                commentsContainer.innerHTML = '';
                try {
                    const q = query(
                        collection(db, 'comments'),
                        where('pageId', '==', this.pageId),
                        orderBy('timestamp', 'desc')
                    );
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => {
                        const commentData = doc.data();
                        this.addCommentToDisplay(commentData.text);
                    });
                } catch (error) {
                    console.error('Erreur lors du chargement des commentaires:', error);
                }
            }
        }

        // Initialisation du système de commentaires
        new CommentSystem('comment-system');
    </script>
</body>
</html>
