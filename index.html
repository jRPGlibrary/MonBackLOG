<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boîte de commentaires</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .comment-box { margin-bottom: 20px; }
        .comment-box textarea { width: 100%; height: 100px; margin-bottom: 10px; }
        .comment { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Commentaires</h1>
    <div class="comment-box">
        <textarea id="commentText" placeholder="Ajoutez un commentaire..."></textarea>
        <button onclick="submitComment()">Soumettre</button>
    </div>
    <div id="comments"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAFsnabnd0A0LeEwO3w9gK-6fhc_rWSnNU",
            authDomain: "jrpglibrary-38e6c.firebaseapp.com",
            projectId: "jrpglibrary-38e6c",
            storageBucket: "jrpglibrary-38e6c.appspot.com",
            messagingSenderId: "82820484706",
            appId: "1:82820484706:web:b1130a49ee3f47c0198b3b",
            measurementId: "G-98KKZX26D8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.submitComment = async function() {
            const commentText = document.getElementById('commentText').value;
            const pageId = window.location.pathname;

            if (commentText.trim()) {
                try {
                    await addDoc(collection(db, 'comments'), {
                        text: commentText,
                        pageId: pageId,
                        timestamp: serverTimestamp()
                    });
                    console.log('Commentaire ajouté avec succès');
                    document.getElementById('commentText').value = '';
                    loadComments();
                } catch (error) {
                    console.error('Erreur lors de l\'ajout du commentaire: ', error);
                }
            } else {
                console.warn('Le texte du commentaire est vide');
            }
        }

        async function loadComments() {
            const pageId = window.location.pathname;
            const commentsDiv = document.getElementById('comments');
            commentsDiv.innerHTML = '';

            try {
                const q = query(collection(db, 'comments'), 
                    where('pageId', '==', pageId),
                    orderBy('timestamp', 'desc')
                );
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    const commentData = doc.data();
                    const commentDiv = document.createElement('div');
                    commentDiv.classList.add('comment');
                    commentDiv.innerText = commentData.text;
                    commentsDiv.appendChild(commentDiv);
                });
                console.log('Commentaires chargés avec succès');
            } catch (error) {
                console.error('Erreur lors du chargement des commentaires: ', error);
            }
        }

        loadComments();
    </script>
</body>
</html>
